<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Hand AI - Adaptive Soft</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            overscroll-behavior: none; /* ป้องกันการดึงหน้าจอลงบนมือถือ */
        }
        
        .glass-card {
            background: rgba(255, 255, 255, 0.6);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        /* ปรับวิดีโอให้ Mirror สำหรับกล้องหน้า */
        .mirror { transform: scaleX(-1); }

        /* ปรับขนาด Video Container ให้พอดีหน้าจอ */
        .video-wrapper {
            position: relative;
            width: 100%;
            border-radius: 24px;
            overflow: hidden;
            background: #000;
            aspect-ratio: 4/3; /* มาตรฐานกล้องมือถือ/เว็บแคม */
        }

        @media (min-width: 768px) {
            .video-wrapper { aspect-ratio: 16/9; }
        }

        .btn-touch {
            touch-action: manipulation;
            transition: all 0.2s active;
        }
        .btn-touch:active { transform: scale(0.95); background: #e0e7ff; }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <header class="p-4 md:p-6 flex justify-between items-center">
        <div>
            <h1 class="text-xl md:text-2xl font-extrabold text-slate-800 tracking-tight">Hand<span class="text-indigo-600">AI</span></h1>
            <div class="flex items-center gap-2">
                <div class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div>
                <span id="status-text" class="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Connected</span>
            </div>
        </div>
        <button onclick="switchCamera()" class="p-3 rounded-full glass-card text-indigo-600 shadow-sm btn-touch">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
        </button>
    </header>

    <main class="flex-1 flex flex-col md:flex-row p-4 gap-4 max-w-7xl mx-auto w-full">
        
        <div class="w-full md:flex-[2]">
            <div class="video-wrapper shadow-2xl shadow-indigo-200/50">
                <video id="video" autoplay playsinline class="w-full h-full object-cover mirror"></video>
                <div class="absolute top-4 right-4 glass-card px-4 py-2 rounded-2xl md:hidden">
                    <p id="latency-mobile" class="text-[10px] font-bold text-indigo-600 italic">-- ms</p>
                </div>
            </div>
        </div>

        <div class="w-full md:flex-1 flex flex-col gap-4">
            
            <div class="glass-card rounded-[32px] p-6 md:p-8 flex flex-col items-center justify-center flex-1 shadow-sm">
                <span class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-2">Detected Sign</span>
                <div id="result" class="text-7xl md:text-8xl font-black text-slate-800 my-2 transition-all">?</div>
                
                <div class="w-full mt-4">
                    <div class="flex justify-between items-end mb-2">
                        <span class="text-xs font-bold text-slate-500">Confidence</span>
                        <span id="conf-val" class="text-indigo-600 font-extrabold">0%</span>
                    </div>
                    <div class="w-full bg-slate-200/50 h-3 rounded-full overflow-hidden border border-white/50">
                        <div id="conf-bar" class="bg-gradient-to-r from-indigo-400 to-purple-400 h-full transition-all duration-300" style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <div class="hidden md:grid grid-cols-2 gap-4">
                <div class="glass-card rounded-2xl p-4">
                    <p class="text-[10px] text-slate-400 font-bold uppercase">Latency</p>
                    <p id="latency-pc" class="text-indigo-600 font-bold">-- ms</p>
                </div>
                <div class="glass-card rounded-2xl p-4">
                    <p class="text-[10px] text-slate-400 font-bold uppercase">Engine</p>
                    <p class="text-indigo-600 font-bold text-xs">TensorFlow</p>
                </div>
            </div>

        </div>
    </main>

    <canvas id="canvas" style="display:none"></canvas>

    <script>
        const video = document.getElementById("video");
        const canvas = document.getElementById("canvas");
        const ctx = canvas.getContext("2d");
        const resultText = document.getElementById("result");
        const confBar = document.getElementById("conf-bar");
        const confVal = document.getElementById("conf-val");
        const statusText = document.getElementById("status-text");
        const latPc = document.getElementById("latency-pc");
        const latMob = document.getElementById("latency-mobile");

        let currentFacingMode = "user";

        function startCamera() {
            // หยุด stream เก่าก่อนสลับ
            if (video.srcObject) {
                video.srcObject.getTracks().forEach(track => track.stop());
            }

            navigator.mediaDevices.getUserMedia({ 
                video: { 
                    facingMode: currentFacingMode,
                    width: { ideal: 640 },
                    height: { ideal: 480 }
                } 
            }).then(stream => {
                video.srcObject = stream;
                // ถ้าเป็นกล้องหลัง ไม่ต้อง Mirror ภาพ
                if (currentFacingMode === "environment") {
                    video.classList.remove("mirror");
                } else {
                    video.classList.add("mirror");
                }
            }).catch(err => {
                statusText.innerText = "Error: " + err.name;
                statusText.classList.replace("text-slate-500", "text-red-500");
            });
        }

        function switchCamera() {
            currentFacingMode = (currentFacingMode === "user") ? "environment" : "user";
            startCamera();
        }

        const ws = new WebSocket("ws://localhost:8000/ws");
        ws.onopen = () => {
            statusText.innerText = "Connected";
            statusText.classList.add("text-green-600");
        };

        let lastSent = Date.now();

        ws.onmessage = e => {
            const data = JSON.parse(e.data);
            if (data.label !== null) {
                resultText.innerText = data.label;
                confBar.style.width = data.confidence + "%";
                confVal.innerText = data.confidence + "%";
                
                const ms = (Date.now() - lastSent);
                latPc.innerText = ms + " ms";
                latMob.innerText = ms + " ms";
            }
        };

        // ส่งภาพประมวลผล (ปรับความถี่ให้เหมาะกับมือถือ)
        setInterval(() => {
            if (video.readyState === video.HAVE_ENOUGH_DATA && ws.readyState === WebSocket.OPEN) {
                // ลดขนาดภาพที่ส่ง เพื่อให้ประมวลผลเร็วบนมือถือ
                canvas.width = 320;
                canvas.height = (video.videoHeight / video.videoWidth) * 320;
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                
                canvas.toBlob(blob => {
                    const reader = new FileReader();
                    reader.onloadend = () => {
                        ws.send(reader.result.split(",")[1]);
                        lastSent = Date.now();
                    };
                    reader.readAsDataURL(blob);
                }, "image/jpeg", 0.5); // บีบอัด 50%
            }
        }, 200);

        startCamera();
    </script>
</body>
</html>